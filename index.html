<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Web-to-Lead Form</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .result-box {
            background-color: #f8fafb; /* Light background */
            border: 1px solid #ddd; /* Border color */
            border-radius: 10px; /* Rounded corners */
            padding: 20px; /* Padding */
            margin-top: 10px; /* Margin */
        }
        .key {
            font-weight: bold; /* Bold for keys */
            color: #4a4a4a; /* Darker color for keys */
        }
        .value {
            color: #1f2937; /* Text color for values */
        }
        .success {
            color: #2E7D32; /* Green for success messages */
            font-weight: bold; /* Bold text for emphasis */
        }
        .error {
            color: #C62828; /* Red for error messages */
            font-weight: bold; /* Bold text for emphasis */
        }
        /* Spinner animation */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">

<!-- Password Protection Screen -->
<div id="passwordScreen" class="w-full max-w-md bg-white shadow-lg rounded-2xl p-8 border border-gray-200">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Password Required</h2>
    <p class="text-gray-600 mb-6 text-center">Please enter the password to access the form.</p>
    
    <div class="mb-6">
        <label class="font-semibold text-gray-700 block mb-2">Password</label>
        <input id="passwordInput" class="mt-1 p-3 w-full border rounded-lg" type="password" placeholder="Enter password" onkeypress="if(event.key === 'Enter') checkPassword()">
    </div>
    
    <div class="text-center">
        <button onclick="checkPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold">Access Form</button>
    </div>
    
    <div id="passwordError" class="mt-4 text-center text-red-600 hidden">Incorrect password. Please try again.</div>
</div>

<!-- Main Form (Hidden until password is correct) -->
<div id="mainContent" class="w-full max-w-3xl bg-white shadow-lg rounded-2xl p-8 border border-gray-200 hidden">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Partner Web-to-Lead Referral Form</h2>

    <!-- Ping API Section -->
    <div class="mt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Ping Phone Number</h2>
        <div class="mb-4">
            <label class="font-semibold text-gray-700">Source Phone</label>
            <input id="pingPhone" class="mt-1 p-3 w-full border rounded-lg" type="text" placeholder="Enter phone number" required pattern="\d{10}">
        </div>

        <div class="mb-4 text-center">
            <button id="pingBtn" onclick="pingApi()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl disabled:bg-gray-400 disabled:cursor-not-allowed">Ping</button>
        </div>

        <div id="pingResult" class="text-center text-gray-700"></div>
    </div>

    <form id="leadForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="font-semibold text-gray-700">First Name</label>
            <input id="firstName" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Last Name</label>
            <input id="lastName" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Gender</label>
            <select id="gender" class="mt-1 p-3 w-full border rounded-lg">
                <option>Male</option>
                <option>Female</option>
                <option>Unknown</option>
            </select>
        </div>

        <div>
            <label class="font-semibold text-gray-700">Date of Birth</label>
            <input id="dob" placeholder="MM/DD/YYYY" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Phone</label>
            <input id="phone" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Mobile Phone</label>
            <input id="mobilePhone" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700">Email</label>
            <input id="email" class="mt-1 p-3 w-full border rounded-lg" type="email">
        </div>

        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700">Street</label>
            <input id="street" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">City</label>
            <input id="city" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">State</label>
            <input id="state" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Postal Code</label>
            <input id="postalCode" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Primary Insurance Company</label>
            <input id="primaryInsurance" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Total Med Count</label>
            <input id="totalMedCount" class="mt-1 p-3 w-full border rounded-lg" type="number">
        </div>

        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700">List Affiliate Name (Campaign)</label>
            <input id="listAffiliateName" class="mt-1 p-3 w-full border rounded-lg" type="text" placeholder="Enter Affiliate Name">
        </div>

        <div class="md:col-span-2">
            <button id="submitBtn" type="button" onclick="submitLead()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl text-lg font-semibold shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">Submit Lead</button>
        </div>
    </form>

    <!-- JSON Toggle Button -->
    <div class="mt-6 text-center">
        <button onclick="toggleJSON()" class="bg-gray-700 hover:bg-gray-800 text-white py-2 px-6 rounded-xl font-semibold shadow-md">Show / Hide JSON Payload</button>
    </div>

    <!-- Hidden JSON Display Box -->
    <pre id="jsonOutput" class="bg-gray-900 text-white p-4 rounded-lg overflow-auto text-sm mt-4 hidden">{}</pre>
</div>

<script>
// Password for accessing the form (change this to your desired password)
const CORRECT_PASSWORD = 'Godisgreat143@';

function checkPassword() {
    const password = document.getElementById('passwordInput').value;
    const passwordError = document.getElementById('passwordError');
    
    if (password === CORRECT_PASSWORD) {
        // Store authentication in sessionStorage
        sessionStorage.setItem('authenticated', 'true');
        // Hide password screen and show main content
        document.getElementById('passwordScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        passwordError.classList.add('hidden');
    } else {
        // Show error message
        passwordError.classList.remove('hidden');
        // Clear the password field
        document.getElementById('passwordInput').value = '';
        // Focus back on password field
        document.getElementById('passwordInput').focus();
    }
}

function checkAuthentication() {
    // Check if user is already authenticated in this session
    if (sessionStorage.getItem('authenticated') === 'true') {
        document.getElementById('passwordScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
    }
}

// Check authentication when page loads
checkAuthentication();

// Lead Management API Base URL
const LEAD_API_BASE = 'https://lead-api-quig.onrender.com';

let isSubmitting = false;
let isPinging = false;
let leadAlreadySubmitted = false;
let phoneExistsInDNC = false;
let pingCompleted = false;
let phoneAlreadySubmitted = false;

function disableFormFields() {
    const form = document.getElementById("leadForm");
    const inputs = form.querySelectorAll("input, select");
    inputs.forEach(input => {
        input.disabled = true;
        input.classList.add("bg-gray-200", "cursor-not-allowed");
    });
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.innerHTML = "Blocked - Phone on Do Not Call List";
    submitBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
    submitBtn.classList.add("bg-red-600");
}

async function submitLead() {
    // Prevent submission if phone is on do-not-call list
    if (phoneExistsInDNC) {
        alert("Cannot submit lead. Phone number is on the Do Not Call list.");
        return;
    }

    // Prevent resubmission if lead was already submitted
    if (leadAlreadySubmitted) {
        alert("Lead has already been submitted. Please refresh the page to submit a new lead.");
        return;
    }

    // Prevent submission if phone was already submitted before
    if (phoneAlreadySubmitted) {
        alert("This phone number has already been submitted previously. Please refresh the page to submit a different lead.");
        return;
    }

    // Prevent multiple clicks during submission
    if (isSubmitting) return;

    const submitBtn = document.getElementById("submitBtn");
    isSubmitting = true;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner"></span>Checking...';

    // Get form values
    const formData = {
        firstName: document.getElementById("firstName").value,
        lastName: document.getElementById("lastName").value,
        gender: document.getElementById("gender").value,
        dob: document.getElementById("dob").value,
        phone: document.getElementById("phone").value,
        mobilePhone: document.getElementById("mobilePhone").value,
        email: document.getElementById("email").value,
        street: document.getElementById("street").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        postalCode: document.getElementById("postalCode").value,
        primaryInsurance: document.getElementById("primaryInsurance").value,
        totalMedCount: document.getElementById("totalMedCount").value,
        listAffiliateName: document.getElementById("listAffiliateName").value
    };

    // Step 1: Check if phone already exists in our database
    try {
        const checkResponse = await fetch(`${LEAD_API_BASE}/api/check/${formData.phone}`);
        const checkData = await checkResponse.json();

        if (checkData.exists) {
            phoneAlreadySubmitted = true;
            alert("This phone number has already been submitted!\n\n" + checkData.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = "Already Submitted";
            submitBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
            submitBtn.classList.add("bg-yellow-600");
            isSubmitting = false;
            return;
        }
    } catch (error) {
        console.warn("Could not check lead database:", error.message);
        // Continue with submission even if check fails
    }

    submitBtn.innerHTML = '<span class="spinner"></span>Submitting...';

    const payload = {
        "Referral_Source_System": "W2L PROXY",
        "LeadSource": "Phone",
        "RecordTypeId": "012390000006DX3AAM",
        "Referral_Source_Details": "Warm Transfer",
        "List_Affiliate_Name": formData.listAffiliateName,
        "Web_Referrer_Company": "001Pi00005enAmuIAE",
        "Referrals": [{
            "FirstName": formData.firstName,
            "LastName": formData.lastName,
            "Gender": formData.gender,
            "Date_of_Birth": formData.dob,
            "Status": "Awaiting Scheduling",
            "Phone": formData.phone,
            "MobilePhone": formData.mobilePhone,
            "Email": formData.email,
            "Street": formData.street,
            "City": formData.city,
            "State": formData.state,
            "PostalCode": formData.postalCode,
            "Episode_ID": "YY321",
            "Scheduling_Status": "Awaiting 1st Patient Contact",
            "Primary_Insurance_Company": formData.primaryInsurance,
            "Total_Med_Count": formData.totalMedCount,
            "Batch_Status": "Unreleased"
        }]
    };

    document.getElementById("jsonOutput").textContent = JSON.stringify(payload, null, 4);

    // Local proxy for lead submission
    const proxyUrl = 'https://cors-proxy-jwvg.onrender.com/proxy';
    const apiUrl = "https://exactcarepharmacy.my.salesforce-sites.com/lead/services/apexrest/v1/LeadApi/";

    try {
        const response = await fetch(proxyUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url: apiUrl, data: payload })
        });

        const responseData = await response.json();

        if (response.ok) {
            // Step 2: Store lead in our database after successful Salesforce submission
            try {
                await fetch(`${LEAD_API_BASE}/api/leads`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        first_name: formData.firstName,
                        last_name: formData.lastName,
                        gender: formData.gender,
                        date_of_birth: formData.dob,
                        phone: formData.phone,
                        mobile_phone: formData.mobilePhone,
                        email: formData.email,
                        street: formData.street,
                        city: formData.city,
                        state: formData.state,
                        postal_code: formData.postalCode,
                        primary_insurance: formData.primaryInsurance,
                        total_med_count: formData.totalMedCount ? parseInt(formData.totalMedCount) : null,
                        list_affiliate_name: formData.listAffiliateName,
                        salesforce_status: "success"
                    })
                });
            } catch (dbError) {
                console.warn("Could not store lead in database:", dbError.message);
            }

            leadAlreadySubmitted = true;
            alert("Lead Submitted Successfully!");
            submitBtn.disabled = false;
            submitBtn.innerHTML = "Lead Submitted";
            submitBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
            submitBtn.classList.add("bg-green-600");
            return;
        } else {
            const errorMessage = responseData.error
                ? responseData.error || "An error occurred."
                : "An unknown error occurred.";
            alert("Error submitting lead: " + errorMessage);
        }
    } catch (error) {
        alert("Network error: " + error.message);
    } finally {
        isSubmitting = false;
        if (!leadAlreadySubmitted && !phoneExistsInDNC && !phoneAlreadySubmitted) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = "Submit Lead";
        }
    }
}

async function pingApi() {
    // Prevent re-ping after successful ping
    if (pingCompleted) {
        if (phoneExistsInDNC) {
            alert("Phone is on Do Not Call list. Form is blocked. Refresh the page to check a different number.");
        } else {
            alert("Phone has already been verified as safe. Refresh the page to check a different number.");
        }
        return;
    }

    // Prevent multiple pings
    if (isPinging) return;

    const pingBtn = document.getElementById("pingBtn");
    isPinging = true;
    pingBtn.disabled = true;
    pingBtn.innerHTML = '<span class="spinner"></span>Pinging...';

    const partnerName = 'MetzInsurance';
    const token = 'w4qwC60-E964tVzmF-n1KB9Ks1dr5peaaHG215215R2dAzFuiV7Zfg==';
    const sourcePhone = document.getElementById("pingPhone").value;

    const corsProxy = 'https://api.allorigins.win/get?url=';
    const apiUrl = `https://func-do-not-call.azurewebsites.net/api/v1/do_not_call/${partnerName}/${sourcePhone}?code=${token}`;
    const url = corsProxy + encodeURIComponent(apiUrl);

    try {
        const response = await fetch(url);
        const responseData = await response.json();

        if (response.ok) {
            const content = JSON.parse(responseData.contents); // Parse the JSON content

            // Mark ping as completed
            pingCompleted = true;

            // Check if phone exists in do-not-call list
            if (content.phoneExists) {
                phoneExistsInDNC = true;
                disableFormFields();
            }

            // Construct result output
            const resultHtml = `
                <div class="result-box">
                    <div class="${content.phoneExists ? 'error' : 'success'}">Ping successful!</div>
                    <div class="key">Phone Exists:</div>
                    <div class="value ${content.phoneExists ? 'error' : 'success'}">${content.phoneExists ? "Yes - DO NOT CALL" : "No - Safe to call"}</div>
                    <div class="key">Source Phone:</div>
                    <div class="value">${content.sourcePhone}</div>
                    <div class="key">HTTP Status:</div>
                    <div class="value">${responseData.status.http_code} - ${responseData.status.content_type}</div>
                    <div class="key">Response Time:</div>
                    <div class="value">${responseData.status.response_time} ms</div>
                    ${content.phoneExists ? '<div class="error mt-2">Form has been disabled. This phone number is on the Do Not Call list.</div>' : ''}
                </div>
            `;
            document.getElementById("pingResult").innerHTML = resultHtml;
        } else {
            const errorHtml = `
                <div class="result-box">
                    <div class="error">Ping failed!</div>
                    <div class="key">Error Status:</div>
                    <div class="value">${response.status} - ${response.statusText}</div>
                </div>
            `;
            document.getElementById("pingResult").innerHTML = errorHtml;
        }
    } catch (error) {
        const errorHtml = `
            <div class="result-box">
                <div class="error">Ping failed!</div>
                <div class="key">Error Message:</div>
                <div class="value">${error.message}</div>
            </div>
        `;
        document.getElementById("pingResult").innerHTML = errorHtml;
    } finally {
        // Re-enable button after ping completes
        isPinging = false;
        pingBtn.disabled = false;

        // Update button based on result
        if (pingCompleted) {
            if (phoneExistsInDNC) {
                pingBtn.innerHTML = "Blocked";
                pingBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
                pingBtn.classList.add("bg-red-600", "hover:bg-red-700");
            } else {
                pingBtn.innerHTML = "Verified âœ“";
                pingBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
                pingBtn.classList.add("bg-green-600", "hover:bg-green-700");
            }
        } else {
            pingBtn.innerHTML = "Ping";
        }
    }
}

function toggleJSON() {
    const box = document.getElementById("jsonOutput");
    box.classList.toggle("hidden");
}
</script>

</body>
</html>
