<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Web-to-Lead Form</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .result-box {
            background-color: #f8fafb;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 10px;
        }
        .key {
            font-weight: bold;
            color: #4a4a4a;
        }
        .value {
            color: #1f2937;
        }
        .success {
            color: #2E7D32;
            font-weight: bold;
        }
        .error {
            color: #C62828;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">

<div class="w-full max-w-3xl bg-white shadow-lg rounded-2xl p-8 border border-gray-200">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Referral Form</h2>

    <!-- Ping API Section -->
    <div class="mt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Ping Phone Number</h2>
        <div class="mb-4">
            <label class="font-semibold text-gray-700">Source Phone</label>
            <input id="pingPhone" class="mt-1 p-3 w-full border rounded-lg" type="text" placeholder="Enter phone number" required pattern="\d{10}">
        </div>

        <div class="mb-4 text-center">
            <button onclick="pingApi()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl">Ping</button>
        </div>

        <div id="pingResult" class="text-center text-gray-700"></div>
    </div>

    <form id="leadForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="font-semibold text-gray-700">First Name</label>
            <input id="firstName" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Last Name</label>
            <input id="lastName" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Gender</label>
            <select id="gender" class="mt-1 p-3 w-full border rounded-lg">
                <option>Male</option>
                <option>Female</option>
                <option>Unknown</option>
            </select>
        </div>

        <div>
            <label class="font-semibold text-gray-700">Date of Birth</label>
            <input id="dob" placeholder="MM/DD/YYYY" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Phone</label>
            <input id="phone" required class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Mobile Phone</label>
            <input id="mobilePhone" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700">Email</label>
            <input id="email" class="mt-1 p-3 w-full border rounded-lg" type="email">
        </div>

        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700">Street</label>
            <input id="street" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">City</label>
            <input id="city" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">State</label>
            <input id="state" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Postal Code</label>
            <input id="postalCode" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Primary Insurance Company</label>
            <input id="primaryInsurance" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div>
            <label class="font-semibold text-gray-700">Total Med Count</label>
            <input id="totalMedCount" class="mt-1 p-3 w-full border rounded-lg" type="number">
        </div>

        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700">List Affiliate Name (Campaign)</label>
            <input id="listAffiliateName" class="mt-1 p-3 w-full border rounded-lg" type="text">
        </div>

        <div class="md:col-span-2">
            <button type="button" onclick="submitLead()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl text-lg font-semibold shadow-md">
                Submit Lead
            </button>
        </div>
    </form>

    <div class="mt-6 text-center">
        <button onclick="toggleJSON()" class="bg-gray-700 hover:bg-gray-800 text-white py-2 px-6 rounded-xl font-semibold shadow-md">
            Show / Hide JSON Payload
        </button>
    </div>

    <pre id="jsonOutput" class="bg-gray-900 text-white p-4 rounded-lg overflow-auto text-sm mt-4 hidden">{}</pre>
</div>

<script>
let isSubmitting = false;
let isPinging = false;

/* ✅ NEW: time-based locks */
let lastPingTime = 0;
let lastSubmitTime = 0;

function toggleJSON() {
    document.getElementById("jsonOutput").classList.toggle("hidden");
}

async function submitLead() {
    const now = Date.now();
    if (now - lastSubmitTime < 5000) return; // ⏱ 5s throttle
    lastSubmitTime = now;

    if (isSubmitting) return;
    isSubmitting = true;

    const btn = document.querySelector('button[onclick="submitLead()"]');
    btn.disabled = true;
    btn.style.pointerEvents = "none";
    btn.innerText = "Submitting...";

    const payload = {
        "Referral_Source_System": "W2L PROXY",
        "LeadSource": "Phone",
        "RecordTypeId": "012390000006DX3AAM",
        "Referral_Source_Details": "Warm Transfer",
        "List_Affiliate_Name": document.getElementById("listAffiliateName").value || "N/A",
        "Web_Referrer_Company": "001Pi00005enAmuIAE",
        "Referrals": [{
            "FirstName": document.getElementById("firstName").value,
            "LastName": document.getElementById("lastName").value,
            "Gender": document.getElementById("gender").value,
            "Date_of_Birth": document.getElementById("dob").value,
            "Status": "Awaiting Scheduling",
            "Phone": document.getElementById("phone").value,
            "MobilePhone": document.getElementById("mobilePhone").value,
            "Email": document.getElementById("email").value,
            "Street": document.getElementById("street").value,
            "City": document.getElementById("city").value,
            "State": document.getElementById("state").value,
            "PostalCode": document.getElementById("postalCode").value,
            "Primary_Insurance_Company": document.getElementById("primaryInsurance").value,
            "Total_Med_Count": document.getElementById("totalMedCount").value,
            "Episode_ID": "YY321",
            "Scheduling_Status": "Awaiting 1st Patient Contact",
            "Batch_Status": "Unreleased"
        }]
    };

    document.getElementById("jsonOutput").textContent = JSON.stringify(payload, null, 4);

    try {
        await fetch("http://localhost:3000/proxy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                url: "https://exactcarepharmacy.my.salesforce-sites.com/lead/services/apexrest/v1/LeadApi/",
                method: "POST",
                data: payload
            })
        });

        alert("Lead submitted successfully");

    } catch (err) {
        alert("Submission failed");
        console.error(err);
    } finally {
        isSubmitting = false;
        btn.disabled = false;
        btn.style.pointerEvents = "auto";
        btn.innerText = "Submit Lead";
    }
}

async function pingApi() {
    const now = Date.now();
    if (now - lastPingTime < 2000) return; // ⏱ 2s throttle
    lastPingTime = now;

    if (isPinging) return;
    isPinging = true;

    const pingBtn = document.querySelector('button[onclick="pingApi()"]');
    pingBtn.disabled = true;
    pingBtn.style.pointerEvents = "none";
    pingBtn.innerText = "Pinging...";

    const partnerName = 'MetzInsurance';
    const token = 'w4qwC60-E964tVzmF-n1KB9Ks1dr5peaaHG215215R2dAzFuiV7Zfg==';
    const sourcePhone = document.getElementById("pingPhone").value;

    const targetUrl =
        `https://func-do-not-call.azurewebsites.net/api/v1/do_not_call/${partnerName}/${sourcePhone}?code=${token}`;

    try {
        const response = await fetch("http://localhost:3000/proxy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                url: targetUrl,
                method: "GET"
            })
        });

        const result = await response.json();
        const body = result.body || {};

        document.getElementById("pingResult").innerHTML = `
            <div class="result-box">
                <div class="success">Ping completed</div>

                <div class="key">Pre-Ping Result:</div>
                <div class="value">${
                    body.phoneExists === true
                        ? "Declined (Existing Patient / Blocked)"
                        : "Cleared (OK to Proceed)"
                }</div>

                <div class="key">Source Phone:</div>
                <div class="value">${sourcePhone}</div>

                <div class="key">HTTP Status:</div>
                <div class="value">${result.http_status}</div>

                <div class="key">Content Type:</div>
                <div class="value">${result.content_type || "N/A"}</div>

                <div class="key">Response Time:</div>
                <div class="value">${result.response_time_ms} ms</div>
            </div>
        `;

    } catch (error) {
        document.getElementById("pingResult").innerHTML = `
            <div class="result-box">
                <div class="error">Ping failed!</div>
                <div class="value">${error.message}</div>
            </div>
        `;
    } finally {
        isPinging = false;
        pingBtn.disabled = false;
        pingBtn.style.pointerEvents = "auto";
        pingBtn.innerText = "Ping";
    }
}
</script>

</body>
</html>
